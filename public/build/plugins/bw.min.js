!function(){var u,w;BOOMR=window.BOOMR||{};BOOMR.plugins=BOOMR.plugins||{};if(!BOOMR.plugins.BW){(w=[{name:"image-0.png",size:11773,timeout:1400},{name:"image-1.png",size:40836,timeout:1200},{name:"image-2.png",size:165544,timeout:1300},{name:"image-3.png",size:382946,timeout:1500},{name:"image-4.png",size:1236278,timeout:1200},{name:"image-5.png",size:4511798,timeout:1200},{name:"image-6.png",size:9092136,timeout:1200}]).end=w.length;w.start=0;w.l={name:"image-l.gif",size:35,timeout:1e3};u={base_url:"",timeout:15e3,nruns:5,latency_runs:10,user_ip:"",block_beacon:!1,test_https:!1,cookie_exp:604800,cookie:"BA",results:[],latencies:[],latency:null,runs_left:0,aborted:!1,complete:!0,running:!1,initialized:!1,ncmp:function(t,e){return t-e},iqr:function(t){var e,i=t.length-1,n=[],s=(t[Math.floor(.25*i)]+t[Math.ceil(.25*i)])/2,r=(t[Math.floor(.75*i)]+t[Math.ceil(.75*i)])/2,a=1.5*(r-s);if(0==a)return t;i++;for(e=0;e<i&&t[e]<r+a;e++)t[e]>s-a&&n.push(t[e]);return n},calc_latency:function(){var t,e,i,n,s,r,a=0,l=0;this.latencies.shift();e=(r=this.iqr(this.latencies.sort(this.ncmp))).length;BOOMR.debug("latencies: "+this.latencies,"bw");BOOMR.debug("lat_filtered: "+r,"bw");for(t=0;t<e;t++){a+=r[t];l+=r[t]*r[t]}i=Math.round(a/e);s=(1.96*(n=Math.sqrt(l/e-a*a/(e*e)))/Math.sqrt(e)).toFixed(2);n=n.toFixed(2);return{mean:i,median:Math.round((r[Math.floor(e/2)]+r[Math.ceil(e/2)])/2),stddev:n,stderr:s}},calc_bw:function(){for(var t,e,i,n,s,r,a,l,o,u,h,c,d,m=0,O=[],b=[],g=0,_=0,M=0,f=0,p=[],B=0;B<this.nruns;B++)if(this.results[B]&&this.results[B].r){h=0;for(t=(e=this.results[B].r).length-1;0<=t&&h<3&&e[t];t--)if(null!==e[t].t){m++;h++;c=1e3*w[t].size/e[t].t;O.push(c);if(e[t].t>this.latency.mean){d=1e3*w[t].size/(e[t].t-this.latency.mean);b.push(d)}else p.push(t+"_"+e[t].t)}}BOOMR.debug("got "+m+" readings","bw");BOOMR.debug("bandwidths: "+O,"bw");BOOMR.debug("corrected: "+b,"bw");if(3<O.length){O=this.iqr(O.sort(this.ncmp));b=this.iqr(b.sort(this.ncmp))}else{O=O.sort(this.ncmp);b=b.sort(this.ncmp)}BOOMR.debug("after iqr: "+O,"bw");BOOMR.debug("corrected: "+b,"bw");m=Math.max(O.length,b.length);for(B=0;B<m;B++){if(B<O.length){g+=O[B];_+=Math.pow(O[B],2)}if(B<b.length){M+=b[B];f+=Math.pow(b[B],2)}}m=O.length;i=Math.round(g/m);n=Math.sqrt(_/m-Math.pow(g/m,2));s=Math.round(1.96*n/Math.sqrt(m));n=Math.round(n);m=O.length-1;r=Math.round((O[Math.floor(m/2)]+O[Math.ceil(m/2)])/2);if(b.length<1){BOOMR.debug("not enough valid corrected datapoints, falling back to uncorrected","bw");p.push("l=="+b.length);a=i;l=n;o=s;u=r}else{m=b.length;a=Math.round(M/m);o=(1.96*(l=Math.sqrt(f/m-Math.pow(M/m,2)))/Math.sqrt(m)).toFixed(2);l=l.toFixed(2);m=b.length-1;u=Math.round((b[Math.floor(m/2)]+b[Math.ceil(m/2)])/2)}BOOMR.debug("amean: "+i+", median: "+r,"bw");BOOMR.debug("corrected amean: "+a+", median: "+u,"bw");return{mean:i,stddev:n,stderr:s,median:r,mean_corrected:a,stddev_corrected:l,stderr_corrected:o,median_corrected:u,debug_info:p}},load_img:function(e,i,n){var t=this.base_url+w[e].name+"?t="+BOOMR.utils.generateId(10),s=0,r=0,a=new Image,l=this;function o(t){return function(){n&&n.call(l,e,r,i,t);if(null!==t){a.onload=a.onerror=null;a=null;clearTimeout(s);l=n=null}}}a.onload=o(!0);a.onerror=o(!1);s=setTimeout(o(null),w[e].timeout+Math.min(400,this.latency?this.latency.mean:400));r=BOOMR.now();a.src=t},lat_loaded:function(t,e,i,n){if(i===this.latency_runs+1){if(null!==n){var s=BOOMR.now()-e;this.latencies.push(s)}0===this.latency_runs&&(this.latency=this.calc_latency());BOOMR.setImmediate(this.iterate,null,null,this)}},img_loaded:function(t,e,i,n){if(i===this.runs_left+1&&!this.results[this.nruns-i].r[t])if(null!==n){var s={start:e,end:BOOMR.now(),t:null,state:n,run:i};n&&(s.t=s.end-s.start);this.results[this.nruns-i].r[t]=s;if(t>=w.end-1||void 0!==this.results[this.nruns-i].r[t+1]){BOOMR.debug(BOOMR.utils.objectToString(this.results[this.nruns-i],void 0,2),"bw");i===this.nruns&&(w.start=t);BOOMR.setImmediate(this.iterate,null,null,this)}else this.load_img(t+1,i,this.img_loaded)}else this.results[this.nruns-i].r[t+1]={t:null,state:null,run:i}},finish:function(){this.latency||(this.latency=this.calc_latency());var t=this.calc_bw(),e={bw:t.median_corrected,bw_err:parseFloat(t.stderr_corrected,10),lat:this.latency.mean,lat_err:parseFloat(this.latency.stderr,10),bw_time:Math.round(BOOMR.now()/1e3)};BOOMR.addVar(e);0<t.debug_info.length&&BOOMR.addVar("bw_debug",t.debug_info.join(","));!isNaN(e.bw)&&0<e.bw&&BOOMR.utils.setCookie(this.cookie,{ba:Math.round(e.bw),be:e.bw_err,l:e.lat,le:e.lat_err,ip:this.user_ip,t:e.bw_time},this.user_ip?this.cookie_exp:0);(this.complete=!0)===this.block_beacon&&BOOMR.sendBeacon();this.running=!1},iterate:function(){if(!this.aborted)if(this.runs_left)if(this.latency_runs)this.load_img("l",this.latency_runs--,this.lat_loaded);else{this.results.push({r:[]});this.load_img(w.start,this.runs_left--,this.img_loaded)}else this.finish()},setVarsFromCookie:function(){var t,e,i,n,s,r,a,l,o=BOOMR.utils.getSubCookies(BOOMR.utils.getCookie(u.cookie));if(o&&o.ba){t=parseInt(o.ba,10);e=parseFloat(o.be,10);i=parseInt(o.l,10)||0;n=parseFloat(o.le,10)||0;s=o.ip.replace(/\.\d+$/,"0");r=parseInt(o.t,10);a=this.user_ip.replace(/\.\d+$/,"0");l=Math.round(BOOMR.now()/1e3);if(s===a&&r>=l-this.cookie_exp&&0<t){this.complete=!0;BOOMR.addVar({bw:t,lat:i,bw_err:e,lat_err:n,bw_time:r});return!0}}return!1}};BOOMR.plugins.BW={init:function(t){if(u.initialized)return this;BOOMR.utils.pluginConfig(u,t,"BW",["base_url","timeout","nruns","cookie","cookie_exp","test_https","block_beacon"]);t&&t.user_ip&&(u.user_ip=t.user_ip);if(!u.base_url)return this;w.start=0;u.runs_left=u.nruns;u.latency_runs=10;u.results=[];u.latencies=[];u.latency=null;u.complete=u.aborted=!1;BOOMR.removeVar("ba","ba_err","lat","lat_err");u.setVarsFromCookie()||BOOMR.subscribe("page_ready",this.run,null,this);u.initialized=!0;return this},run:function(){var t;if(u.running||u.complete)return this;(t=BOOMR.window.document.createElement("a")).href=u.base_url;if(!u.test_https&&"https:"===t.protocol){BOOMR.info("HTTPS detected, skipping bandwidth test","bw");(u.complete=!0)===u.block_beacon&&BOOMR.sendBeacon();return this}u.base_url=t.href;u.running=!0;setTimeout(this.abort,u.timeout);u.iterate();return this},abort:function(){u.aborted=!0;u.running&&u.finish()},is_complete:function(){return!0!==u.block_beacon||u.complete}}}}();
//# sourceMappingURL=bw.min.js.map